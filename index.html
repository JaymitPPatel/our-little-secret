<!DOCTYPE html>
<html>
<body>

<canvas id="announcementCanvas" width="900" height="600" style="position: absolute; left: 0; top: 0; z-index: 3"></canvas>
<canvas id="revealCanvas" width="900" height="600" style="position: absolute; left: 0; top: 0; z-index: 2"></canvas>
<canvas id="cameraCanvas" width="900" height="600" style="position: absolute; left: 0; top: 600px; z-index: 1"></canvas>
<canvas id="gifCanvas" width="900" height="600" style="position: absolute; left: 0; top: 600px; z-index: 4"></canvas>
<video id="videoElement" style="position: absolute; left: 0; top: 50%; display: none;"></video> <!-- Hidden video element -->


<button id="startRecordingButton" style="position: absolute; left: 0; top: 600px; width: 450px; height: 50px; font-size: 30px; z-index: 5;">Start Recording</button>
<button id="stopRecordingButton" style="position: absolute; left: 450px; top: 600px; width: 450px; height: 50px; font-size: 30px; z-index: 6;" disabled>Stop Recording</button>

<script>
const announcementCanvas = document.getElementById("announcementCanvas");
const announcementCtx = announcementCanvas.getContext("2d");
const revealCanvas = document.getElementById("revealCanvas");
const revealCtx = revealCanvas.getContext("2d");
const cameraCanvas = document.getElementById("cameraCanvas");
const cameraCtx = cameraCanvas.getContext("2d");
const gifCanvas = document.getElementById("gifCanvas");
const gifCtx = gifCanvas.getContext("2d");
let isDrawing = false;
const brushSize = 25; // Half the size of the brush
let clearedArea = 0;
const halfCanvasArea = (announcementCanvas.width * announcementCanvas.height) / 2;
const videoElement = document.getElementById("videoElement");
const startRecordingButton = document.getElementById("startRecordingButton");
const stopRecordingButton = document.getElementById("stopRecordingButton");
let mediaRecorder;
let recordedChunks = [];
let allowedToDraw = false;
let isRecording = false;

// Add event listeners for continuous reveal on both mouse and touch events
announcementCanvas.addEventListener('mousedown', startDrawing);
announcementCanvas.addEventListener('mousemove', draw);
announcementCanvas.addEventListener('mouseup', endDrawing);
announcementCanvas.addEventListener('touchstart', startDrawing);
announcementCanvas.addEventListener('touchmove', draw);
announcementCanvas.addEventListener('touchend', endDrawing);

// Load the sound effect
const revealSound = new Audio('data/scratch_effect.mp4');

// Draw the announcement image onto the canvas
const announcementImage = new Image();
announcementImage.src = "data/announcement.avif";
announcementImage.onload = function() {
    announcementCtx.drawImage(announcementImage, 0, 0, announcementCanvas.width, announcementCanvas.height);
            
    // Write a message
    announcementCtx.font = "40px Arial";
    announcementCtx.fillStyle = "white";
    announcementCtx.textAlign = "center";
    let ypos = 0.18;
    announcementCtx.fillText("Scratch here", announcementCanvas.width*0.5, announcementCanvas.height*ypos);
    announcementCtx.fillText("to reveal", announcementCanvas.width*0.5, announcementCanvas.height*(ypos+0.05));
    announcementCtx.fillText("another secret!", announcementCanvas.width*0.5, announcementCanvas.height*(ypos+0.05*2));
};

// Draw the reveal image onto the canvas
const revealImage = new Image();
revealImage.src = 'data/reveal.jpg';
revealImage.onload = function() {
    revealCtx.drawImage(revealImage, 0, 0, revealCanvas.width, revealCanvas.height);
};


startRecordingButton.addEventListener('click', startRecording);
stopRecordingButton.addEventListener('click', stopRecording);

function startDrawing(e) {
  e.preventDefault();
  isDrawing = true;
  // Play sound effect
  revealSound.volume = 0.2;
  revealSound.loop = true;
  revealSound.play();
  draw(e);
}

function draw(e) {
  if (isDrawing) {
    e.preventDefault();
    const rect = announcementCanvas.getBoundingClientRect();
    let x, y;
    if (e.type === 'touchmove') {
      x = e.touches[0].clientX - rect.left;
      y = e.touches[0].clientY - rect.top;
    } else {
      x = e.clientX - rect.left;
      y = e.clientY - rect.top;
    }
    announcementCtx.beginPath();
    announcementCtx.arc(x, y, brushSize, 0, 2 * Math.PI);
    announcementCtx.fillStyle = 'rgba(0, 0, 0, 0)';
    announcementCtx.fill();
    announcementCtx.clearRect(x - brushSize, y - brushSize, brushSize * 2, brushSize * 2); // Make a circular area see-through
  
    // Calculate cleared area
    clearedArea += Math.PI * Math.pow(brushSize, 2);
    
    // Check if 50% of the canvas has been cleared
    if ((clearedArea >= halfCanvasArea) && isRecording) {
      showGif();
    }
  }
}

function endDrawing() {
  isDrawing = false;
  
  // Stop sound effect
  revealSound.pause();
  revealSound.currentTime = 0;
}

function showGif() {

// Alternate gif load, but will have to animate manually.
//  var gifImage = new Image();
//  gifImage.src = "data/reveal.gif";
//  gifCtx.drawImage(gifImage,0,0);

  // show gif
  const gifImage = document.createElement("img");
  gifImage.src = "data/reveal.gif";
  gifImage.alt = "GIF";
  gifImage.style.position = "absolute";
  gifImage.style.left = "0";
  gifImage.style.top = "0";
  gifImage.style.width = "100%";
  gifImage.style.height = "100%";
  gifImage.style.zIndex = "5";
  gifImage.style.objectFit = "cover"; // Ensure the GIF covers the entire canvas
  gifCanvas.appendChild(gifImage);

  setTimeout(shareRecordingMessage, 10000);  
  setTimeout(stopRecording, 30000);
}

function shareRecordingMessage() {
    // Write a message
    gifCtx.font = "25px Arial";
    gifCtx.fillStyle = "black";
    gifCtx.textAlign = "center";
    gifCtx.fillText("Please share your reaction video with us!", gifCanvas.width*0.5, gifCanvas.height*0.25);
}

function startRecording() {
  startRecordingButton.disabled = true;
  stopRecordingButton.disabled = false;
  isRecording = true;
  
  // Get access to the camera and microphone
  navigator.mediaDevices.getUserMedia({ video: true, audio: true })
    .then(function(stream) {
      // Hide the default video display
      videoElement.style.display = "none";

      videoElement.srcObject = stream;
      
      // Mute local playback
      videoElement.muted = true;
      videoElement.play();
      
      // Start recording video
      mediaRecorder = new MediaRecorder(stream);
      mediaRecorder.ondataavailable = handleDataAvailable;
      mediaRecorder.start();
      
      // Display live webcam feed on camera canvas
      setInterval(drawVideoFrame, 16); // Update every ~16ms (about 60fps)
   
    })
    .catch(function(err) {
      console.log("An error occurred: " + err);
    });
}

function drawVideoFrame() {
  // Calculate dimensions to preserve aspect ratio
  const aspectRatio = videoElement.videoWidth / videoElement.videoHeight;
  let drawWidth = cameraCanvas.width;
  let drawHeight = cameraCanvas.height;
  if (aspectRatio > 1) {
    drawHeight = cameraCanvas.width / aspectRatio;
  } else {
    drawWidth = cameraCanvas.height * aspectRatio;
  }
  
  // Draw the current frame of the video onto the camera canvas
  cameraCtx.drawImage(videoElement, 0, 0, drawWidth, drawHeight);
}

function stopRecording() {
  if (isRecording)
  {
    startRecordingButton.disabled = false;
    stopRecordingButton.disabled = true;

    mediaRecorder.stop();
    videoElement.pause();
    videoElement.srcObject = null; // Disconnect the media stream
    mediaRecorder = null; // Reset MediaRecorder
    recordedChunks = []; // Clear recorded chunks
  }
}

function handleDataAvailable(event) {
  if (event.data.size > 0) {
    recordedChunks.push(event.data);
    const blob = new Blob(recordedChunks, { type: 'video/mp4' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'reaction_video.mp4';
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
  }
}
</script>

</body>
</html>
